import React, { useEffect, useRef } from "react";
import { render, screen } from "@testing-library/react";
import { useRunner, UseRunnerProps, UseRunnerReturn } from "../useRunner";
import { importCode } from "../utils";

// Helper component to consume hook
const Container = ({
  onRendered,
  ...props
}: UseRunnerProps & {
  onRendered?: (result: UseRunnerReturn) => void;
}) => {
  const result = useRunner(props);

  const onRenderedRef = useRef(onRendered);
  onRenderedRef.current = onRendered;

  useEffect(() => {
    onRenderedRef.current?.(result);
  }, [result]);

  return <>{result.element}</>;
};

// RTL setup (similar to your original setup, but using render)
const setup = (props: UseRunnerProps) => {
  let result: UseRunnerReturn;

  const utils = render(
    <Container
      {...props}
      onRendered={(value) => {
        result = value;
      }}
    />
  );

  return {
    ...utils,
    getResult: () => result!,
    update: (newProps: UseRunnerProps) => {
      utils.rerender(
        <Container
          {...newProps}
          onRendered={(value) => {
            result!.element = value.element;
            result!.error = value.error;
          }}
        />
      );
    },
  };
};

describe("useRunner hook", () => {
  test("code update", () => {
    const { getResult, update, container } = setup({ code: `hello` });
    const result = getResult();
    expect(result.element).toBeNull();
    expect(result.error).toBe("ReferenceError: hello is not defined");

    update({ code: `<div>hello</div>` });
    expect(container).toHaveTextContent("hello");
    expect(getResult().error).toBeNull();
  });

  test("scope update", () => {
    const { getResult, update, container } = setup({
      code: `<div>hello {value}</div>`,
      scope: { value: "react" },
    });

    expect(container).toHaveTextContent("hello react");

    update({
      code: `<div>hello {value}</div>`,
      scope: { value: "react-runner" },
    });
    expect(container).toHaveTextContent("hello react-runner");

    update({
      code: `<div>hello! {value}</div>`,
      scope: { value: "react-runner" },
    });
    expect(container).toHaveTextContent("hello! react-runner");
  });

  test("cache behavior", () => {
    const spy = jest.spyOn(console, "error").mockImplementation(() => {});
    const { getResult, update, container } = setup({ code: `() => <div>{value}</div>` });

    expect(getResult().element).toBeNull();
    expect(getResult().error).toBe("ReferenceError: value is not defined");

    update({ code: `() => <div>hello</div>` });
    expect(container).toHaveTextContent("hello");
    expect(getResult().error).toBeNull();

    update({ code: `() => <div>{hello}</div>` });
    expect(container).toHaveTextContent("hello"); // stale cached
    expect(getResult().error).toBe("ReferenceError: hello is not defined");

    update({ code: `() => <div>react</div>` });
    expect(container).toHaveTextContent("react");
    expect(getResult().error).toBeNull();

    spy.mockRestore();
  });

  test("disable cache", () => {
    const spy = jest.spyOn(console, "error").mockImplementation(() => {});
    const { getResult, update, container } = setup({
      code: `() => <div>{value}</div>`,
      disableCache: true,
    });

    expect(getResult().element).toBeNull();
    expect(getResult().error).toBe("ReferenceError: value is not defined");

    update({ code: `() => <div>hello</div>`, disableCache: true });
    expect(container).toHaveTextContent("hello");
    expect(getResult().error).toBeNull();

    update({ code: `() => <div>{hello}</div>`, disableCache: true });
    expect(getResult().element).toBeNull();
    expect(getResult().error).toBe("ReferenceError: hello is not defined");

    spy.mockRestore();
  });

  test("toggle cache", () => {
    const spy = jest.spyOn(console, "error").mockImplementation(() => {});
    const { getResult, update, container } = setup({
      code: `() => <div>hello</div>`,
      disableCache: true,
    });

    expect(container).toHaveTextContent("hello");

    update({ code: `() => <div>{hello}</div>`, disableCache: true });
    expect(getResult().element).toBeNull();
    expect(getResult().error).toBe("ReferenceError: hello is not defined");

    update({ code: `() => <div>{hello}</div>`, disableCache: false });
    expect(container).toHaveTextContent("hello"); // cached output
    expect(getResult().error).toBe("ReferenceError: hello is not defined");

    update({ code: `() => <div>{hello}</div>`, disableCache: true });
    expect(getResult().element).toBeNull();
    expect(getResult().error).toBe("ReferenceError: hello is not defined");

    spy.mockRestore();
  });

  test("multi files", () => {
    const { getResult, update, container } = setup({
      code: `import { foo } from 'foo'
      export default () => <>{foo}</>`,
      scope: {
        import: {
          foo: importCode(`export const foo = 'Foo'`),
        },
      },
    });
    expect(container).toHaveTextContent("Foo");

    update({
      code: `import { foo } from 'foo'
      export default () => <>{foo}</>`,
      scope: {
        import: {
          foo: importCode(`export const foo = 'Bar'`),
        },
      },
    });
    expect(container).toHaveTextContent("Bar");
  });
});
